<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tegych AI | Next Gen Workspace</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Code Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js" defer></script>

    <style>
        :root {
            /* --- CORE PALETTE (Modern Dark) --- */
            --bg-app: #09090b;
            --bg-sidebar: #121214;
            --bg-panel: #18181b;
            --bg-input: #27272a;
            --border: #27272a;
            --primary: #3b82f6; /* Tegych Blue */
            --primary-glow: rgba(59, 130, 246, 0.4);
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            
            /* Chat Bubbles */
            --user-bubble: #3b82f6;
            --bot-bubble: #18181b;
        }

        /* --- THEME ENGINE --- */
        
        /* 1. Light (Clean) */
        [data-theme="light"] {
            --bg-app: #ffffff; --bg-sidebar: #f8fafc; --bg-panel: #ffffff; --bg-input: #f1f5f9;
            --border: #e2e8f0; --primary: #0f172a; --text-main: #0f172a; --text-muted: #64748b;
            --user-bubble: #0f172a; --bot-bubble: #f8fafc;
        }
        /* 2. Cyberpunk */
        [data-theme="cyberpunk"] {
            --bg-app: #020205; --bg-sidebar: #050510; --bg-panel: #0a0a1a; --bg-input: #121225;
            --border: #ff00ff; --primary: #00e5ff; --primary-glow: rgba(0, 229, 255, 0.6);
            --text-main: #e0faff; --text-muted: #ff0099; --user-bubble: #ff0099; --bot-bubble: #0a0a1a;
        }
        /* 3. Midnight */
        [data-theme="midnight"] {
            --bg-app: #0f172a; --bg-sidebar: #1e293b; --bg-panel: #1e293b; --bg-input: #334155;
            --border: #334155; --primary: #38bdf8; --text-main: #f8fafc; --text-muted: #94a3b8;
            --user-bubble: #0284c7; --bot-bubble: #1e293b;
        }
        /* 4. Synthwave (NEW) */
        [data-theme="synthwave"] {
            --bg-app: #2b213a; --bg-sidebar: #241b2f; --bg-panel: #241b2f; --bg-input: #432c58;
            --border: #ff71ce; --primary: #b967ff; --text-main: #fff; --text-muted: #01cdfe;
            --user-bubble: #b967ff; --bot-bubble: #241b2f;
        }
        /* 5. Gruvbox (NEW) */
        [data-theme="gruvbox"] {
            --bg-app: #282828; --bg-sidebar: #1d2021; --bg-panel: #32302f; --bg-input: #504945;
            --border: #665c54; --primary: #fabd2f; --text-main: #ebdbb2; --text-muted: #a89984;
            --user-bubble: #d79921; --bot-bubble: #3c3836;
        }
        /* 6. Lavender (NEW) */
        [data-theme="lavender"] {
            --bg-app: #fdfbff; --bg-sidebar: #f5f3ff; --bg-panel: #fff; --bg-input: #f3e8ff;
            --border: #e9d5ff; --primary: #9333ea; --text-main: #4c1d95; --text-muted: #8b5cf6;
            --user-bubble: #a855f7; --bot-bubble: #f5f3ff;
        }
        /* 7. Gold Luxury (NEW) */
        [data-theme="luxury"] {
            --bg-app: #000000; --bg-sidebar: #0a0a0a; --bg-panel: #111; --bg-input: #1a1a1a;
            --border: #d4af37; --primary: #d4af37; --primary-glow: rgba(212, 175, 55, 0.5);
            --text-main: #f0e6d2; --text-muted: #8a7c5d; --user-bubble: #d4af37; --bot-bubble: #111;
        }
        /* 8. Forest (NEW) */
        [data-theme="forest"] {
            --bg-app: #051a14; --bg-sidebar: #02120e; --bg-panel: #0a261c; --bg-input: #11382b;
            --border: #2d6a4f; --primary: #52b788; --text-main: #d8f3dc; --text-muted: #74c69d;
            --user-bubble: #40916c; --bot-bubble: #0a261c;
        }
        /* 9. Dracula */
        [data-theme="dracula"] {
            --bg-app: #282a36; --bg-sidebar: #21222c; --bg-panel: #282a36; --bg-input: #44475a;
            --border: #6272a4; --primary: #ff79c6; --text-main: #f8f8f2; --text-muted: #bd93f9;
            --user-bubble: #bd93f9; --bot-bubble: #44475a;
        }
        /* 10. Solarized (NEW) */
        [data-theme="solarized"] {
            --bg-app: #002b36; --bg-sidebar: #073642; --bg-panel: #073642; --bg-input: #586e75;
            --border: #586e75; --primary: #268bd2; --text-main: #93a1a1; --text-muted: #657b83;
            --user-bubble: #2aa198; --bot-bubble: #073642;
        }
        /* 11. Neumorphism */
        [data-theme="neumorphism"] {
            --bg-app: #e0e5ec; --bg-sidebar: #e0e5ec; --bg-panel: #e0e5ec; --bg-input: #e0e5ec;
            --border: transparent; --primary: #6d5dfc; --text-main: #4a4a4a; --text-muted: #888;
            --user-bubble: #6d5dfc; --bot-bubble: #e0e5ec;
            --shadow-card: 9px 9px 16px rgb(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5);
        }
        /* 12. Monokai (NEW) */
        [data-theme="monokai"] {
            --bg-app: #272822; --bg-sidebar: #1e1f1c; --bg-panel: #272822; --bg-input: #3e3d32;
            --border: #75715e; --primary: #a6e22e; --text-main: #f8f8f2; --text-muted: #75715e;
            --user-bubble: #f92672; --bot-bubble: #3e3d32;
        }

        /* --- GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body {
            background: var(--bg-app); color: var(--text-main); font-family: var(--font-main);
            height: 100vh; display: flex; overflow: hidden; font-size: 15px;
            transition: background 0.4s ease, color 0.4s ease;
        }

        /* --- LAYOUT GRID --- */
        .app-container { display: flex; width: 100%; height: 100%; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 24px 16px; gap: 24px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 50;
        }
        
        .logo-area { display: flex; align-items: center; gap: 12px; padding: 0 8px; }
        .logo-icon {
            width: 32px; height: 32px; background: var(--primary); border-radius: 8px;
            display: grid; place-items: center; color: white; font-weight: 800; font-size: 18px;
            box-shadow: 0 0 15px var(--primary-glow);
        }
        .logo-text { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }

        .nav-group { display: flex; flex-direction: column; gap: 8px; flex: 1; overflow-y: auto; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600; padding: 0 12px; margin-bottom: 4px; }
        
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius-sm);
            color: var(--text-muted); cursor: pointer; transition: 0.2s; font-weight: 500;
        }
        .nav-item:hover, .nav-item.active { background: var(--bg-input); color: var(--text-main); }
        .nav-item i { width: 20px; text-align: center; }

        .model-switcher {
            background: var(--bg-panel); padding: 4px; border-radius: var(--radius-lg);
            border: 1px solid var(--border); display: flex; position: relative;
        }
        .model-btn {
            flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 600;
            z-index: 2; cursor: pointer; color: var(--text-muted); transition: color 0.3s;
        }
        .model-btn.active { color: white; }
        .slider {
            position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: calc(100% - 8px);
            background: var(--primary); border-radius: 12px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1; box-shadow: 0 2px 8px var(--primary-glow);
        }
        .model-switcher[data-mode="pro"] .slider { transform: translateX(100%); }

        /* --- MAIN CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--bg-app); }

        .top-bar {
            height: 60px; padding: 0 24px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border); background: rgba(var(--bg-app), 0.8);
            backdrop-filter: blur(12px); z-index: 10;
        }
        
        .chat-wrapper { flex: 1; overflow-y: auto; padding: 40px 0; display: flex; flex-direction: column; scroll-behavior: smooth; }
        
        /* Empty State (Welcome) */
        .welcome-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; padding: 20px; opacity: 1; transition: opacity 0.3s;
        }
        .welcome-screen.hidden { display: none; opacity: 0; }
        .welcome-icon { font-size: 48px; color: var(--primary); margin-bottom: 24px; }
        .welcome-title { font-size: 32px; font-weight: 700; margin-bottom: 12px; }
        .welcome-subtitle { color: var(--text-muted); max-width: 500px; margin-bottom: 40px; }
        
        .suggestion-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; max-width: 700px; width: 100%; }
        .suggestion-card {
            background: var(--bg-panel); border: 1px solid var(--border); padding: 16px;
            border-radius: var(--radius-lg); cursor: pointer; text-align: left; transition: 0.2s;
        }
        .suggestion-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .suggestion-title { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
        .suggestion-desc { font-size: 12px; color: var(--text-muted); }

        /* Messages */
        .message-row { display: flex; justify-content: center; padding: 12px 24px; width: 100%; animation: fadeUp 0.3s ease; }
        .message-container { display: flex; gap: 16px; max-width: 800px; width: 100%; }
        .message-row.user { background: transparent; }
        .message-row.bot { background: var(--bg-app); }
        
        .msg-avatar {
            width: 32px; height: 32px; border-radius: 6px; flex-shrink: 0;
            display: grid; place-items: center; font-size: 14px;
        }
        .msg-avatar.user { background: var(--text-muted); color: var(--bg-app); }
        .msg-avatar.bot { background: var(--primary); color: white; }

        .msg-bubble {
            flex: 1; font-size: 16px; line-height: 1.6; color: var(--text-main);
            overflow-x: hidden;
        }
        .msg-bubble p { margin-bottom: 12px; }
        .msg-bubble p:last-child { margin-bottom: 0; }
        
        /* Code Blocks */
        pre {
            background: #0d0d0d; border-radius: 8px; margin: 12px 0; border: 1px solid #333;
            overflow: hidden; position: relative;
        }
        .code-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #1a1a1a; padding: 6px 12px; font-size: 12px; color: #888; border-bottom: 1px solid #333;
        }
        pre code { display: block; padding: 12px; overflow-x: auto; font-family: var(--font-code); font-size: 14px; color: #ccc; }
        
        /* Input Area */
        .input-section {
            padding: 24px; background: var(--bg-app); position: relative;
        }
        .input-box {
            max-width: 800px; margin: 0 auto; background: var(--bg-input);
            border: 1px solid var(--border); border-radius: 20px; padding: 12px;
            display: flex; align-items: flex-end; gap: 12px; box-shadow: var(--shadow-card);
            transition: border-color 0.2s;
        }
        .input-box:focus-within { border-color: var(--primary); }
        
        textarea {
            flex: 1; background: transparent; border: none; color: var(--text-main);
            font-size: 16px; font-family: inherit; resize: none; max-height: 200px;
            padding: 8px 0; min-height: 24px;
        }
        
        .send-btn {
            width: 36px; height: 36px; border-radius: 10px; background: var(--primary);
            color: white; border: none; cursor: pointer; display: grid; place-items: center;
            transition: 0.2s;
        }
        .send-btn:hover { filter: brightness(1.1); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Mobile Menu */
        .mobile-toggle { display: none; font-size: 20px; cursor: pointer; }
        .overlay { position: fixed; inset: 0; background: black; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 40; }
        .overlay.active { opacity: 0.5; pointer-events: all; }

        /* Settings Modal */
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-sidebar); padding: 24px; border-radius: 16px; border: 1px solid var(--border);
            width: 90%; max-width: 400px; z-index: 100; opacity: 0; pointer-events: none; transition: 0.2s;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal.open { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: all; }
        
        select { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); border-radius: 8px; margin-top: 8px; outline: none; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -280px; height: 100%; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .sidebar.active { left: 0; }
            .mobile-toggle { display: block; }
            .suggestion-grid { grid-template-columns: 1fr; }
            .message-container { gap: 10px; }
            .msg-avatar { width: 24px; height: 24px; font-size: 12px; }
        }
    </style>
</head>
<body data-theme="dark">

    <div class="overlay" onclick="toggleSidebar()"></div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settings-modal">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Workspace Settings</h3>
            <i class="fas fa-times" onclick="toggleSettings()" style="cursor:pointer"></i>
        </div>
        
        <div style="margin-bottom:20px;">
            <label style="font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase;">Interface Theme</label>
            <select id="theme-select" onchange="setTheme(this.value)">
                <option value="dark">üåë Tegych Dark (Default)</option>
                <option value="light">‚òÄÔ∏è Clean Light</option>
                <option value="midnight">üåå Midnight Blue</option>
                <option value="cyberpunk">üëæ Cyberpunk Neon</option>
                <option value="synthwave">üåÜ Synthwave Retro</option>
                <option value="gruvbox">üìú Gruvbox Code</option>
                <option value="dracula">üßõ Dracula</option>
                <option value="luxury">üèÜ Luxury Gold</option>
                <option value="lavender">üå∏ Lavender Soft</option>
                <option value="forest">üå≤ Deep Forest</option>
                <option value="solarized">üåÖ Solarized Dark</option>
                <option value="monokai">üé® Monokai Vivid</option>
                <option value="neumorphism">‚ö™ Neumorphism</option>
            </select>
        </div>
        
        <button onclick="toggleSettings()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Save & Close</button>
    </div>

    <div class="app-container">
        
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo-area">
                <div class="logo-icon">Tegych logo.png</div>
                <div class="logo-text">Tegych AI</div>
            </div>

            <!-- Model Switcher -->
            <div class="model-switcher" id="model-switcher" data-mode="flash">
                <div class="slider"></div>
                <div class="model-btn active" onclick="setModel('flash')">Flash ‚ö°</div>
                <div class="model-btn" onclick="setModel('pro')">Ultra üöÄ</div>
            </div>

            <nav class="nav-group">
                <div class="nav-label">Workspace</div>
                <div class="nav-item active" onclick="newChat()"><i class="fas fa-plus"></i> New Chat</div>
                <div class="nav-item"><i class="fas fa-compass"></i> Discover</div>
                <div class="nav-item"><i class="fas fa-archive"></i> Library</div>
                
                <div class="nav-label" style="margin-top:20px;">Tools</div>
                <div class="nav-item" onclick="toggleSettings()"><i class="fas fa-cog"></i> Settings</div>
                <div class="nav-item" onclick="exportChat()"><i class="fas fa-download"></i> Export Chat</div>
            </nav>

            <div style="padding:12px; background:var(--bg-panel); border-radius:12px; border:1px solid var(--border);">
                <div style="font-size:12px; color:var(--text-muted);">Current Plan</div>
                <div style="font-weight:700; margin-bottom:4px;">Enterprise Team</div>
                <div style="font-size:10px; color:var(--primary);">Unlimited Access</div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="chat-area">
            <div class="top-bar">
                <div style="display:flex; align-items:center; gap:12px;">
                    <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
                    <span style="font-weight:600;" id="chat-title">New Session</span>
                </div>
                <div style="display:flex; gap:12px;">
                    <i class="far fa-star" style="color:var(--text-muted); cursor:pointer;"></i>
                    <i class="fas fa-share-alt" style="color:var(--text-muted); cursor:pointer;"></i>
                </div>
            </div>

            <div class="chat-wrapper" id="chat-wrapper">
                
                <!-- WELCOME SCREEN -->
                <div class="welcome-screen" id="welcome-screen">
                    <div class="welcome-icon"><i class="fas fa-robot"></i></div>
                    <h1 class="welcome-title">How can Tegych help you?</h1>
                    <p class="welcome-subtitle">Advanced AI model capable of coding, analysis, and creative writing. Select a mode or start typing.</p>
                    
                    <div class="suggestion-grid">
                        <div class="suggestion-card" onclick="setInput('Write a Python script to parse CSV')">
                            <div class="suggestion-title">üêç Python Script</div>
                            <div class="suggestion-desc">Generate code for data parsing</div>
                        </div>
                        <div class="suggestion-card" onclick="setInput('Explain Quantum Computing like I am 5')">
                            <div class="suggestion-title">‚öõÔ∏è Explain Concepts</div>
                            <div class="suggestion-desc">Simple breakdown of complex topics</div>
                        </div>
                        <div class="suggestion-card" onclick="setInput('Draft a professional email for a client')">
                            <div class="suggestion-title">üìß Write Email</div>
                            <div class="suggestion-desc">Professional business communication</div>
                        </div>
                        <div class="suggestion-card" onclick="setInput('Create a marketing strategy for SaaS')">
                            <div class="suggestion-title">üìà Marketing Plan</div>
                            <div class="suggestion-desc">Strategy for product launch</div>
                        </div>
                    </div>
                </div>

                <!-- MESSAGES -->
                <div id="messages-container"></div>
            </div>

            <!-- INPUT -->
            <div class="input-section">
                <div class="input-box">
                    <button style="background:none; border:none; color:var(--text-muted); cursor:pointer; padding-bottom:10px;"><i class="fas fa-paperclip"></i></button>
                    <textarea id="user-input" rows="1" placeholder="Message Tegych..." oninput="autoResize(this)"></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()"><i class="fas fa-arrow-up"></i></button>
                </div>
                <div style="text-align:center; font-size:11px; color:var(--text-muted); margin-top:10px;">
                    ¬© 2025 Tegcompany. All rights reserved.
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIG ---
        const API_KEY = "8fVDXLED6cbXbT0ObTYuBhitYkjB5ABV"; // ‚ö†Ô∏è ENTER API KEY HERE
        const API_URL = "https://api.mistral.ai/v1/chat/completions";

        let state = {
            model: 'flash', // flash = small, pro = medium/large
            history: [{ 
                role: "system", 
                content: "You are Tegych AI, a helpful and expert assistant. I am NOT Mistral. " +
                         "Detect the user's language. If Russian, answer Russian. If English, answer English. " +
                         "Use Markdown formatting." 
            }]
        };

        const dom = {
            input: document.getElementById('user-input'),
            container: document.getElementById('messages-container'),
            welcome: document.getElementById('welcome-screen'),
            wrapper: document.getElementById('chat-wrapper'),
            switcher: document.getElementById('model-switcher')
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            marked.setOptions({
                highlight: (code, lang) => highlight.highlightAuto(code).value
            });
            
            // Textarea Enter key
            dom.input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        // --- FUNCTIONS ---

        function setInput(text) {
            dom.input.value = text;
            dom.input.focus();
            autoResize(dom.input);
        }

        function setModel(mode) {
            state.model = mode;
            dom.switcher.setAttribute('data-mode', mode);
            document.querySelectorAll('.model-btn').forEach(btn => btn.classList.remove('active'));
            // Visual toggle update handled by CSS
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function newChat() {
            dom.container.innerHTML = '';
            state.history = [state.history[0]];
            dom.welcome.classList.remove('hidden');
            document.getElementById('chat-title').innerText = "New Session";
        }

        function appendMessage(role, text) {
            // Hide welcome screen on first message
            dom.welcome.classList.add('hidden');

            const row = document.createElement('div');
            row.className = `message-row ${role}`;
            
            const container = document.createElement('div');
            container.className = 'message-container';
            
            // Avatar
            const avatar = document.createElement('div');
            avatar.className = `msg-avatar ${role}`;
            avatar.innerHTML = role === 'user' ? '<i class="fas fa-user"></i>' : 'T'; // T for Tegych
            
            // Bubble
            const bubble = document.createElement('div');
            bubble.className = 'msg-bubble';
            
            if (role === 'user') {
                bubble.innerText = text;
            } else {
                bubble.innerHTML = marked.parse(text); // Render Markdown
                // Add copy buttons to code blocks
                bubble.querySelectorAll('pre').forEach(pre => {
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `<span>Code</span> <span style="cursor:pointer;" onclick="copyCode(this)">Copy</span>`;
                    pre.insertBefore(header, pre.firstChild);
                });
            }

            if(role === 'user') {
                container.appendChild(bubble);
                container.appendChild(avatar);
            } else {
                container.appendChild(avatar);
                container.appendChild(bubble);
            }

            row.appendChild(container);
            dom.container.appendChild(row);
            
            // Auto scroll
            dom.wrapper.scrollTop = dom.wrapper.scrollHeight;
            return bubble;
        }

        async function sendMessage() {
            const text = dom.input.value.trim();
            if (!text) return;

            dom.input.value = '';
            dom.input.style.height = 'auto'; // Reset height
            
            appendMessage('user', text);
            state.history.push({ role: "user", content: text });

            // Create placeholder for AI response
            const botBubble = appendMessage('bot', '<span class="typing-dots">Typing...</span>');
            
            try {
                const modelId = state.model === 'pro' ? 'mistral-medium' : 'mistral-small-latest';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: modelId,
                        messages: state.history,
                        temperature: 0.7,
                        stream: false // Using standard fetch for simplicity in this demo, simulating typing
                    })
                });

                if(!response.ok) throw new Error("API Error");
                
                const data = await response.json();
                const aiText = data.choices[0].message.content;
                
                // Simulate Typewriter Effect
                botBubble.innerHTML = ''; // Clear "Typing..."
                let i = 0;
                // For long texts, instant render is better for UX, but let's do a fast chunk render
                // Actually, for markdown, typing effect is tricky. Let's do a Fade In effect instead.
                botBubble.innerHTML = marked.parse(aiText);
                
                // Re-add copy headers
                botBubble.querySelectorAll('pre').forEach(pre => {
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    header.innerHTML = `<span>Code</span> <span style="cursor:pointer;" onclick="copyCode(this)">Copy</span>`;
                    pre.insertBefore(header, pre.firstChild);
                });

                state.history.push({ role: "assistant", content: aiText });
                document.getElementById('chat-title').innerText = text.substring(0, 20) + "...";

            } catch (error) {
                botBubble.innerText = "‚ö†Ô∏è Error: " + error.message;
            }
        }

        // --- UTILS ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
        }

        function copyCode(btn) {
            const code = btn.parentElement.nextElementSibling.innerText;
            navigator.clipboard.writeText(code);
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = "Copy", 2000);
        }

        function exportChat() {
            let content = "CHAT EXPORT - TEGYCH AI\n\n";
            state.history.forEach(msg => {
                if(msg.role !== 'system') {
                    content += `[${msg.role.toUpperCase()}]:\n${msg.content}\n\n----------------\n\n`;
                }
            });
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'tegych-export.txt';
            a.click();
        }
    </script>
</body>
</html>
